#include "../include/MalwareScanner.h"
#include <fstream>
#include <iostream>
#include <sstream>

MalwareScanner::MalwareScanner() {
    scanner = new AhoCorasick();
    signatureDB = new Trie();
}

MalwareScanner::~MalwareScanner() {
    delete scanner;
    delete signatureDB;
}

void MalwareScanner::loadSignatures(const std::string& filename) {
    std::ifstream file(filename);
    if (!file.is_open()) {
        std::cerr << "Could not open signatures file: " << filename << std::endl;
        return;
    }
    
    std::string signature;
    while (std::getline(file, signature)) {
        if (!signature.empty()) {
            addSignature(signature);
        }
    }
    
    file.close();
    scanner->build();
}

void MalwareScanner::addSignature(const std::string& signature) {
    signatures.push_back(signature);
    signatureDB->insert(signature);
    scanner->addPattern(signature);
    scanner->build();  // Rebuild after adding pattern
}

std::vector<std::pair<int, std::string>> MalwareScanner::scanFile(const std::string& filename) {
    std::ifstream file(filename);
    if (!file.is_open()) {
        std::cerr << "Could not open file: " << filename << std::endl;
        return std::vector<std::pair<int, std::string>>();
    }
    
    std::stringstream buffer;
    buffer << file.rdbuf();
    std::string content = buffer.str();
    file.close();
    
    return scanText(content);
}

std::vector<std::pair<int, std::string>> MalwareScanner::scanText(const std::string& text) {
    return scanner->search(text);
}

void MalwareScanner::displayResults(const std::vector<std::pair<int, std::string>>& matches) {
    std::cout << "\n=== Malware Scan Results ===" << std::endl;
    
    if (matches.empty()) {
        std::cout << "✓ No malware signatures detected." << std::endl;
    } else {
        std::cout << "⚠ Found " << matches.size() << " malware signature(s):" << std::endl;
        for (const auto& match : matches) {
            std::cout << "  - Position " << match.first << ": \"" << match.second << "\"" << std::endl;
        }
    }
}
